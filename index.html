<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema de Pedidos - Peças e Serviços</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0; background: #f4f7f8; color: #333;
  }
  header {
    background: #34495e; color: white; padding: 15px 20px;
    font-size: 1.5em; font-weight: bold;
  }
  nav {
    display: flex; background: #2c3e50;
  }
  nav button {
    flex: 1;
    padding: 15px;
    background: #2c3e50;
    border: none;
    color: white;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.3s;
  }
  nav button:hover, nav button.active {
    background: #1abc9c;
    color: #fff;
  }
  main {
    padding: 20px;
    max-width: 900px;
    margin: auto;
  }
  section {
    display: none;
  }
  section.active {
    display: block;
  }
  h2 {
    color: #34495e;
    margin-bottom: 15px;
  }
  label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
  }
  input, select, textarea, button {
    margin-top: 5px;
    padding: 8px;
    width: 100%;
    max-width: 400px;
    box-sizing: border-box;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1em;
  }
  textarea {
    height: 60px;
    resize: vertical;
  }
  button.primary {
    background: #1abc9c;
    color: white;
    border: none;
    cursor: pointer;
    margin-top: 15px;
    max-width: 200px;
  }
  button.primary:hover {
    background: #16a085;
  }
  ul.list-pedidos {
    list-style: none;
    padding: 0;
  }
  ul.list-pedidos li {
    background: white;
    margin-bottom: 10px;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  ul.list-pedidos li span.status {
    padding: 5px 10px;
    border-radius: 12px;
    font-weight: bold;
    font-size: 0.9em;
    color: white;
  }
  span.status.finalizado { background: #27ae60; }
  span.status.rascunho { background: #f39c12; }
  span.status.cancelado { background: #c0392b; }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.5);
  }
  .modal-content {
    background-color: #fff;
    margin: 50px auto;
    padding: 20px;
    border-radius: 8px;
    max-width: 700px;
    position: relative;
  }
  .close-btn {
    position: absolute;
    right: 15px; top: 15px;
    font-size: 1.5em;
    font-weight: bold;
    color: #999;
    cursor: pointer;
  }
  .close-btn:hover {
    color: #333;
  }
  .flex-row {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }
  .flex-row > * {
    flex: 1;
    min-width: 150px;
  }
  .item-list {
    margin-top: 10px;
    max-height: 150px;
    overflow-y: auto;
    background: #ecf0f1;
    padding: 10px;
    border-radius: 6px;
  }
  .item-list li {
    margin-bottom: 5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .item-list button {
    background: #e74c3c;
    border: none;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    cursor: pointer;
  }
  .item-list button:hover {
    background: #c0392b;
  }
  .history {
    background: #f9f9f9;
    border: 1px solid #ddd;
    padding: 10px;
    max-height: 150px;
    overflow-y: auto;
    margin-top: 10px;
    font-size: 0.9em;
    color: #555;
  }
</style>
</head>
<body>

<header>Sistema de Pedidos - Peças e Serviços</header>

<nav>
  <button class="active" data-tab="tab-viaturas">Viaturas/Equipamentos</button>
  <button data-tab="tab-fornecedores">Fornecedores</button>
  <button data-tab="tab-pedidos">Pedidos</button>
</nav>

<main>
  <!-- Viaturas -->
  <section id="tab-viaturas" class="active">
    <h2>Cadastro de Viaturas/Equipamentos</h2>
    <div class="flex-row">
      <input type="text" id="viaturaPrefixo" placeholder="Prefixo" />
      <input type="text" id="viaturaMarca" placeholder="Marca" />
      <input type="text" id="viaturaChassi" placeholder="Chassi/Série" />
      <input type="text" id="viaturaModelo" placeholder="Modelo" />
      <input type="number" id="viaturaAno" placeholder="Ano" min="1900" max="2100" />
    </div>
    <button class="primary" onclick="addViatura()">Adicionar Viatura</button>

    <h3>Viaturas Cadastradas</h3>
    <ul id="listaViaturas"></ul>
  </section>

  <!-- Fornecedores -->
  <section id="tab-fornecedores">
    <h2>Cadastro de Fornecedores</h2>
    <div class="flex-row">
      <input type="text" id="fornecedorNome" placeholder="Nome do Fornecedor" />
      <input type="text" id="fornecedorContato" placeholder="Contato" />
    </div>
    <button class="primary" onclick="addFornecedor()">Adicionar Fornecedor</button>

    <h3>Fornecedores Cadastrados</h3>
    <ul id="listaFornecedores"></ul>
  </section>

  <!-- Pedidos -->
  <section id="tab-pedidos">
    <h2>Pedidos</h2>
    <button class="primary" onclick="abrirModalPedido()">Novo Pedido</button>

    <h3>Lista de Pedidos</h3>
    <ul id="listaPedidos" class="list-pedidos"></ul>
  </section>
</main>

<!-- Modal Novo Pedido -->
<div id="modalPedido" class="modal" aria-hidden="true" role="dialog" aria-labelledby="modalTitle" aria-modal="true">
  <div class="modal-content">
    <span class="close-btn" onclick="fecharModalPedido()" title="Fechar">&times;</span>
    <h2 id="modalTitle">Novo Pedido</h2>

    <label for="tipoPedido">Tipo de Pedido:</label>
    <select id="tipoPedido" onchange="renderItemInputs()">
      <option value="peca">Peças/Acessórios</option>
      <option value="servico">Serviços</option>
    </select>

    <label for="pedidoViatura">Viatura/Equipamento:</label>
    <select id="pedidoViatura"></select>

    <label for="pedidoFornecedor">Fornecedor:</label>
    <select id="pedidoFornecedor"></select>

    <label for="pedidoResponsavel">Responsável:</label>
    <input type="text" id="pedidoResponsavel" placeholder="Nome do responsável" />

    <label for="pedidoData">Data:</label>
    <input type="date" id="pedidoData" />

    <label for="pedidoObservacoes">Observações:</label>
    <textarea id="pedidoObservacoes" placeholder="Observações"></textarea>

    <h3>Adicionar Item</h3>
    <div id="itemInputs" class="flex-row"></div>
    <button class="primary" onclick="addItem()">Adicionar Item</button>

    <h3>Itens do Pedido</h3>
    <ul id="listaItens" class="item-list"></ul>

    <h3>Histórico de Edições</h3>
    <div id="historico" class="history"></div>

    <div style="margin-top:20px;">
      <button class="primary" onclick="salvarPedido()">Salvar Pedido</button>
      <button onclick="exportarCSV()" class="btn-inline" style="margin-left:10px;">Exportar CSV</button>
      <button onclick="gerarPDF()" class="btn-inline" style="margin-left:10px;">Gerar PDF</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  // Dados em memória
  const viaturas = [];
  const fornecedores = [];
  const pedidos = [];
  let itensPedido = [];
  let historico = [];

  // Elementos
  const viaturaPrefixo = document.getElementById('viaturaPrefixo');
  const viaturaMarca = document.getElementById('viaturaMarca');
  const viaturaChassi = document.getElementById('viaturaChassi');
  const viaturaModelo = document.getElementById('viaturaModelo');
  const viaturaAno = document.getElementById('viaturaAno');
  const listaViaturas = document.getElementById('listaViaturas');

  const fornecedorNome = document.getElementById('fornecedorNome');
  const fornecedorContato = document.getElementById('fornecedorContato');
  const listaFornecedores = document.getElementById('listaFornecedores');

  const listaPedidos = document.getElementById('listaPedidos');

  // Modal elementos
  const modal = document.getElementById('modalPedido');
  const tipoPedido = document.getElementById('tipoPedido');
  const pedidoViatura = document.getElementById('pedidoViatura');
  const pedidoFornecedor = document.getElementById('pedidoFornecedor');
  const pedidoResponsavel = document.getElementById('pedidoResponsavel');
  const pedidoData = document.getElementById('pedidoData');
  const pedidoObservacoes = document.getElementById('pedidoObservacoes');
  const itemInputs = document.getElementById('itemInputs');
  const listaItens = document.getElementById('listaItens');
  const historicoDiv = document.getElementById('historico');

  // Navegação abas
  document.querySelectorAll('nav button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.getAttribute('data-tab');
      document.querySelectorAll('main section').forEach(sec => {
        sec.classList.toggle('active', sec.id === tab);
      });
    });
  });

  // Funções Viaturas
  function addViatura() {
    const prefixo = viaturaPrefixo.value.trim();
    const marca = viaturaMarca.value.trim();
    const chassi = viaturaChassi.value.trim();
    const modelo = viaturaModelo.value.trim();
    const ano = parseInt(viaturaAno.value);
    if (!prefixo || !marca || !chassi || !modelo || !ano) {
      alert('Preencha todos os campos da viatura.');
      return;
    }
    viaturas.push({ prefixo, marca, chassi, modelo, ano });
    atualizarListaViaturas();
    atualizarSelectsModal();
    viaturaPrefixo.value = '';
    viaturaMarca.value = '';
    viaturaChassi.value = '';
    viaturaModelo.value = '';
    viaturaAno.value = '';
  }
  function atualizarListaViaturas() {
    listaViaturas.innerHTML = viaturas.map((v,i) =>
      `<li><strong>${v.prefixo}</strong> - ${v.marca} ${v.modelo} (${v.ano}) - Chassi: ${v.chassi}</li>`
    ).join('');
  }

  // Funções Fornecedores
  function addFornecedor() {
    const nome = fornecedorNome.value.trim();
    const contato = fornecedorContato.value.trim();
    if (!nome) {
      alert('Informe o nome do fornecedor.');
      return;
    }
    fornecedores.push({ nome, contato });
    atualizarListaFornecedores();
    atualizarSelectsModal();
    fornecedorNome.value = '';
    fornecedorContato.value = '';
  }
  function atualizarListaFornecedores() {
    listaFornecedores.innerHTML = fornecedores.map((f,i) =>
      `<li><strong>${f.nome}</strong> - Contato: ${f.contato || '-'}</li>`
    ).join('');
  }

  // Atualiza selects do modal
  function atualizarSelectsModal() {
    pedidoViatura.innerHTML = '<option value="">Selecione a Viatura</option>' + viaturas.map((v,i) => `<option value="${i}">${v.prefixo} - ${v.marca} ${v.modelo} (${v.ano})</option>`).join('');
    pedidoFornecedor.innerHTML = '<option value="">Selecione o Fornecedor</option>' + fornecedores.map((f,i) => `<option value="${i}">${f.nome}</option>`).join('');
  }

  // Modal abrir/fechar
  function abrirModalPedido() {
    if (viaturas.length === 0 || fornecedores.length === 0) {
      alert('Cadastre pelo menos uma viatura e um fornecedor antes de criar um pedido.');
      return;
    }
    modal.style.display = 'block';
    modal.setAttribute('aria-hidden', 'false');
    resetModalForm();
  }
  function fecharModalPedido() {
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
  }
  window.onclick = function(event) {
    if (event.target === modal) fecharModalPedido();
  };

  // Reset modal form
  function resetModalForm() {
    tipoPedido.value = 'peca';
    pedidoViatura.value = '';
    pedidoFornecedor.value = '';
    pedidoResponsavel.value = '';
    pedidoData.value = '';
    pedidoObservacoes.value = '';
    itensPedido = [];
    historico = [];
    renderItemInputs();
    renderListaItens();
    atualizarHistorico();
  }

  // Render inputs para item conforme tipo
  function renderItemInputs() {
    const tipo = tipoPedido.value;
    itemInputs.innerHTML = '';
    if (tipo === 'peca') {
      itemInputs.innerHTML = `
        <input type="text" id="itemCodigo" placeholder="Código Referência" />
        <input type="text" id="itemDescricao" placeholder="Descrição" />
        <input type="number" id="itemQuantidade" placeholder="Quantidade" min="1" />
        <input type="number" id="itemValorUnitario" placeholder="Valor Unitário (R$)" min="0" step="0.01" />
        <input type="number" id="itemDesconto" placeholder="Desconto (%)" min="0" max="100" step="0.01" />
      `;
    } else {
      itemInputs.innerHTML = `
        <input type="text" id="itemDescricao" placeholder="Descrição do Serviço" />
        <input type="number" id="itemHoras" placeholder="Horas" min="0" step="0.1" />
        <input type="number" id="itemValorHora" placeholder="Valor por Hora (R$)" min="0" step="0.01" />
      `;
    }
  }

  // Adicionar item ao pedido
  function addItem() {
    const tipo = tipoPedido.value;
    if (tipo === 'peca') {
      const codigo = document.getElementById('itemCodigo').value.trim();
      const descricao = document.getElementById('itemDescricao').value.trim();
      const quantidade = parseInt(document.getElementById('itemQuantidade').value);
      const valorUnitario = parseFloat(document.getElementById('itemValorUnitario').value);
      const desconto = parseFloat(document.getElementById('itemDesconto').value) || 0;
      if (!codigo || !descricao || !quantidade || isNaN(valorUnitario)) {
        alert('Preencha todos os campos do item peça corretamente.');
        return;
      }
      itensPedido.push({ codigo, descricao, quantidade, valorUnitario, desconto });
    } else {
      const descricao = document.getElementById('itemDescricao').value.trim();
      const horas = parseFloat(document.getElementById('itemHoras').value);
      const valorHora = parseFloat(document.getElementById('itemValorHora').value);
      if (!descricao || isNaN(horas) || isNaN(valorHora)) {
        alert('Preencha todos os campos do item serviço corretamente.');
        return;
      }
      itensPedido.push({ descricao, horas, valorHora });
    }
    renderListaItens();
    addHistorico(`Item adicionado: ${tipo === 'peca' ? itensPedido[itensPedido.length-1].descricao : itensPedido[itensPedido.length-1].descricao}`);
    limparCamposItem();
  }

  // Limpar campos de item
  function limparCamposItem() {
    const inputs = itemInputs.querySelectorAll('input');
    inputs.forEach(i => i.value = '');
  }

  // Renderizar lista de itens
  function renderListaItens() {
    listaItens.innerHTML = '';
    itensPedido.forEach((item, i) => {
      let texto = '';
      if (tipoPedido.value === 'peca') {
        texto = `${item.codigo} - ${item.descricao} - Qtd: ${item.quantidade} - Valor Unit: R$${item.valorUnitario.toFixed(2)} - Desc: ${item.desconto.toFixed(2)}%`;
      } else {
        texto = `${item.descricao} - Horas: ${item.horas} - Valor Hora: R$${item.valorHora.toFixed(2)}`;
      }
      const li = document.createElement('li');
      li.textContent = texto + ' ';
      const btnDel = document.createElement('button');
      btnDel.textContent = 'Excluir';
      btnDel.onclick = () => {
        itensPedido.splice(i, 1);
        renderListaItens();
        addHistorico('Item removido');
      };
      li.appendChild(btnDel);
      listaItens.appendChild(li);
    });
  }

  // Histórico
  function addHistorico(texto) {
    const now = new Date();
    historico.unshift(`${now.toLocaleString()}: ${texto}`);
    atualizarHistorico();
  }

  function atualizarHistorico() {
    historicoDiv.innerHTML = historico.map(h => `<div>${h}</div>`).join('');
  }

  // Salvar pedido (em memória)
  function salvarPedido() {
    const viaturaIndex = pedidoViatura.value;
    const fornecedorIndex = pedidoFornecedor.value;
    const responsavel = pedidoResponsavel.value.trim();
    const data = pedidoData.value;
    const observacoes = pedidoObservacoes.value.trim();

    if (viaturaIndex === '' || fornecedorIndex === '' || !responsavel || !data) {
      alert('Preencha todos os campos obrigatórios do pedido.');
      return;
    }
    if (itensPedido.length === 0) {
      alert('Adicione pelo menos um item ao pedido.');
      return;
    }

    const pedido = {
      id: pedidos.length + 1,
      tipo: tipoPedido.value,
      viatura: viaturas[viaturaIndex],
      fornecedor: fornecedores[fornecedorIndex],
      responsavel,
      data,
      observacoes,
      itens: [...itensPedido],
      status: 'finalizado',
      historico: [...historico]
    };
    pedidos.push(pedido);
    alert(`Pedido #${pedido.id} salvo com sucesso!`);

    atualizarListaPedidos();
    fecharModalPedido();
  }

  // Atualizar lista de pedidos na aba
  function atualizarListaPedidos() {
    listaPedidos.innerHTML = '';
    pedidos.forEach(p => {
      const li = document.createElement('li');
      li.innerHTML = `
        <div>
          <strong>Pedido #${p.id}</strong> - ${p.tipo === 'peca' ? 'Peças/Acessórios' : 'Serviços'}<br/>
          Viatura: ${p.viatura.prefixo} - ${p.viatura.marca} ${p.viatura.modelo} (${p.viatura.ano})<br/>
          Fornecedor: ${p.fornecedor.nome}<br/>
          Responsável: ${p.responsavel}<br/>
          Data: ${p.data}<br/>
          Observações: ${p.observacoes || '-'}
        </div>
        <span class="status ${p.status}">${p.status.charAt(0).toUpperCase() + p.status.slice(1)}</span>
      `;
      listaPedidos.appendChild(li);
    });
  }

  // Exportar CSV simples
  function exportarCSV() {
    if (itensPedido.length === 0) {
      alert('Adicione itens antes de exportar.');
      return;
    }
    let csv = '';
    if (tipoPedido.value === 'peca') {
      csv += 'Código Referência,Descrição,Quantidade,Valor Unitário,Desconto (%)\n';
      itensPedido.forEach(i => {
        csv += `"${i.codigo}","${i.descricao}",${i.quantidade},${i.valorUnitario.toFixed(2)},${i.desconto.toFixed(2)}\n`;
      });
    } else {
      csv += 'Descrição,Horas,Valor por Hora\n';
      itensPedido.forEach(i => {
        csv += `"${i.descricao}",${i.horas},${i.valorHora.toFixed(2)}\n`;
      });
    }
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `pedido_${tipoPedido.value}_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Gerar PDF básico com jsPDF
  async function gerarPDF() {
    if (itensPedido.length === 0) {
      alert('Adicione itens antes de gerar PDF.');
      return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(16);
    doc.text('Pedido de ' + (tipoPedido.value === 'peca' ? 'Peças/Acessórios' : 'Serviços'), 10, 20);

    doc.setFontSize(12);
    doc.text(`Viatura: ${pedidoViatura.options[pedidoViatura.selectedIndex].text}`, 10, 30);
    doc.text(`Fornecedor: ${pedidoFornecedor.options[pedidoFornecedor.selectedIndex].text}`, 10, 38);
    doc.text(`Responsável: ${pedidoResponsavel.value}`, 10, 46);
    doc.text(`Data: ${pedidoData.value}`, 10, 54);
    doc.text('Observações:', 10, 62);
    doc.text(pedidoObservacoes.value || '-', 10, 70);

    let startY = 80;
    doc.text('Itens:', 10, startY);
    startY += 8;

    itensPedido.forEach((item, i) => {
      let line = '';
      if (tipoPedido.value === 'peca') {
        line = `${i+1}. ${item.codigo} - ${item.descricao} - Qtd: ${item.quantidade} - Valor Unit: R$${item.valorUnitario.toFixed(2)} - Desc: ${item.desconto.toFixed(2)}%`;
      } else {
        line = `${i+1}. ${item.descricao} - Horas: ${item.horas} - Valor Hora: R$${item.valorHora.toFixed(2)}`;
      }
      doc.text(line, 10, startY);
      startY += 8;
      if (startY > 280) {
        doc.addPage();
        startY = 20;
      }
    });

    doc.save(`pedido_${tipoPedido.value}_${new Date().toISOString().slice(0,10)}.pdf`);
  }

  // Inicialização
  atualizarSelectsModal();
  renderItemInputs();
</script>

</body>
</html>
