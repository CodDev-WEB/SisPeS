<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cadastro de Fornecedores e Gestão de Empenhos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
    }
    h2, h3 {
      color: #333;
    }
    form {
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      max-width: 700px;
      margin-bottom: 30px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
      text-transform: uppercase;
    }
    input[type="text"],
    input[type="email"],
    input[type="number"] {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-transform: uppercase; /* Força visual maiúsculo */
    }
    input[type="email"] {
      text-transform: none; /* Email não deve ser maiúsculo visualmente */
    }
    button.primary {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #007bff;
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
      text-transform: uppercase;
    }
    button.primary:hover {
      background-color: #0056b3;
    }
    ul#listaFornecedores {
      list-style: none;
      padding-left: 0;
      max-width: 900px;
    }
    ul#listaFornecedores li {
      background: #fff;
      margin-bottom: 8px;
      padding: 10px 15px;
      border-radius: 6px;
      box-shadow: 0 0 3px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 14px;
      flex-wrap: wrap;
    }
    ul#listaFornecedores li strong {
      text-transform: uppercase;
    }
    ul#listaFornecedores li button {
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #007bff;
      background: white;
      color: #007bff;
      text-transform: uppercase;
      margin-left: 10px;
      white-space: nowrap;
    }
    ul#listaFornecedores li button:hover {
      background: #007bff;
      color: white;
    }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      padding-top: 50px;
    }
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 900px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      position: relative;
    }
    .close-btn {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      position: absolute;
      right: 15px;
      top: 10px;
    }
    .close-btn:hover,
    .close-btn:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: left;
      font-size: 13px;
    }
    th {
      background-color: #f2f2f2;
      text-transform: uppercase;
    }
    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #dc3545;
      background: white;
      color: #dc3545;
      cursor: pointer;
      text-transform: uppercase;
    }
    .btn-small:hover {
      background: #dc3545;
      color: white;
    }
    .btn-add-item {
      margin-top: 10px;
      background-color: #28a745;
      border: none;
      color: white;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
      padding: 8px 15px;
      text-transform: uppercase;
    }
    .btn-add-item:hover {
      background-color: #218838;
    }
    .section-title {
      margin-top: 20px;
      font-weight: bold;
      font-size: 16px;
      text-transform: uppercase;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
    }
    .flex-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .flex-col {
      flex: 1;
      min-width: 150px;
    }
    .input-small {
      width: 100%;
      box-sizing: border-box;
    }
    .text-right {
      text-align: right;
    }
  </style>
</head>
<body>

<section id="tab-fornecedores">
  <h2>Cadastro de Fornecedores</h2>
  <form id="formFornecedor" onsubmit="event.preventDefault(); adicionarFornecedor();">
    <label for="fornecedorNome">Nome Fantasia *</label>
    <input type="text" id="fornecedorNome" required placeholder="Nome Fantasia" autocomplete="off" />

    <label for="fornecedorCNPJ">CNPJ *</label>
    <input type="text" id="fornecedorCNPJ" required placeholder="CNPJ (somente números)" maxlength="14" autocomplete="off" />

    <label for="fornecedorEmail">Email *</label>
    <input type="email" id="fornecedorEmail" required placeholder="Email" autocomplete="off" />

    <label for="fornecedorContato">Contato</label>
    <input type="text" id="fornecedorContato" placeholder="Contato" autocomplete="off" />

    <button type="submit" class="primary">Adicionar Fornecedor</button>
  </form>

  <h3>Fornecedores Cadastrados</h3>
  <ul id="listaFornecedores"></ul>
</section>

<!-- Modal Gestão de Empenhos -->
<div id="modalEmpenhos" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="fecharModalEmpenhos()">&times;</span>
    <h2>Gestão de Empenhos - <span id="modalFornecedorNome"></span></h2>

    <!-- Formulário cadastro empenho -->
    <form id="formEmpenho" onsubmit="event.preventDefault(); adicionarEmpenho();">
      <div class="section-title">Dados do Empenho</div>
      <div class="flex-row">
        <div class="flex-col">
          <label for="numeroEmpenho">Número do Empenho *</label>
          <input type="text" id="numeroEmpenho" required autocomplete="off" />
        </div>
        <div class="flex-col">
          <label for="planoInterno">Plano Interno</label>
          <input type="text" id="planoInterno" autocomplete="off" />
        </div>
        <div class="flex-col">
          <label for="notaCredito">Nota de Crédito</label>
          <input type="text" id="notaCredito" autocomplete="off" />
        </div>
      </div>
      <div class="flex-row">
        <div class="flex-col">
          <label for="pec">PEC</label>
          <input type="text" id="pec" autocomplete="off" />
        </div>
        <div class="flex-col">
          <label for="oog">O.O.G</label>
          <input type="text" id="oog" autocomplete="off" />
        </div>
        <div class="flex-col">
          <label for="recurso">Recurso</label>
          <input type="text" id="recurso" autocomplete="off" />
        </div>
      </div>
      <div class="flex-row">
        <div class="flex-col">
          <label for="descontoEmpenho">Desconto Geral (%)</label>
          <input type="number" id="descontoEmpenho" min="0" max="100" step="0.01" value="0" />
        </div>
        <div class="flex-col">
          <label for="pregao">Número do Pregão</label>
          <input type="text" id="pregao" autocomplete="off" />
        </div>
        <div class="flex-col">
          <label for="itemPregao">Item Pregão</label>
          <input type="number" id="itemPregao" min="0" autocomplete="off" />
        </div>
        <div class="flex-col">
          <label for="quantidadePregao">Quantidade Pregão</label>
          <input type="number" id="quantidadePregao" min="0" autocomplete="off" />
        </div>
      </div>
      <div class="flex-row">
        <div class="flex-col" style="flex: 1 1 100%;">
          <label for="naturezaDespesa">Natureza da Despesa</label>
          <input type="text" id="naturezaDespesa" placeholder="00.00.00" autocomplete="off" />
        </div>
      </div>

      <div class="section-title">Itens do Empenho</div>
      <div class="flex-row" style="align-items: flex-end;">
        <div class="flex-col" style="flex: 3;">
          <label for="descricaoItem">Descrição do Item *</label>
          <input type="text" id="descricaoItem" autocomplete="off" />
        </div>
        <div class="flex-col" style="flex: 1;">
          <label for="valorUnitarioItem">Valor Unitário (R$) *</label>
          <input type="number" id="valorUnitarioItem" min="0" step="0.01" />
        </div>
        <div class="flex-col" style="flex: 1;">
          <label for="descontoItem">Desconto Item (%)</label>
          <input type="number" id="descontoItem" min="0" max="100" step="0.01" value="0" />
        </div>
        <div class="flex-col" style="flex: 1;">
          <button type="button" class="btn-add-item" onclick="adicionarItemEmpenho()">Adicionar Item</button>
        </div>
      </div>

      <table id="tabelaItensEmpenho">
        <thead>
          <tr>
            <th>Descrição do Item</th>
            <th>Valor Unitário (R$)</th>
            <th>Desconto (%)</th>
            <th>Valor Total (R$)</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <!-- Itens adicionados aparecerão aqui -->
        </tbody>
        <tfoot>
          <tr>
            <th colspan="3" class="text-right">Valor Total do Empenho (sem desconto geral):</th>
            <th id="valorTotalItens">0,00</th>
            <th></th>
          </tr>
          <tr>
            <th colspan="3" class="text-right">Desconto Geral do Empenho (%):</th>
            <th id="descontoGeralExibido">0,00%</th>
            <th></th>
          </tr>
          <tr>
            <th colspan="3" class="text-right">Valor Total com Desconto Geral (R$):</th>
            <th id="valorTotalComDesconto">0,00</th>
            <th></th>
          </tr>
        </tfoot>
      </table>

      <button type="submit" class="primary" style="margin-top: 15px;">Salvar Empenho</button>
    </form>

    <div class="section-title">Empenhos Cadastrados</div>
    <table id="tabelaEmpenhos">
      <thead>
        <tr>
          <th>Número Empenho</th>
          <th>Plano Interno</th>
          <th>Nota Crédito</th>
          <th>PEC</th>
          <th>O.O.G</th>
          <th>Recurso</th>
          <th>Desconto Geral (%)</th>
          <th>Pregão</th>
          <th>Item Pregão</th>
          <th>Qtd Pregão</th>
          <th>Natureza Despesa</th>
          <th>Valor Total (R$)</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <!-- Empenhos cadastrados aparecerão aqui -->
      </tbody>
    </table>
  </div>
</div>

<script>
  const fornecedores = [];

  // Força maiúsculo em inputs texto (exceto email)
  ['fornecedorNome', 'fornecedorContato', 'fornecedorCNPJ'].forEach(id => {
    const input = document.getElementById(id);
    input.addEventListener('input', e => {
      e.target.value = e.target.value.toUpperCase();
    });
  });

  // Força maiúsculo em inputs do modal empenho (texto)
  ['numeroEmpenho', 'planoInterno', 'notaCredito', 'pec', 'oog', 'recurso', 'pregao', 'naturezaDespesa', 'descricaoItem'].forEach(id => {
    const input = document.getElementById(id);
    input.addEventListener('input', e => {
      e.target.value = e.target.value.toUpperCase();
    });
  });

  // Validação simples do CNPJ: somente números e 14 dígitos
  function validarCNPJ(cnpj) {
    const cnpjNumeros = cnpj.replace(/\D/g, '');
    return cnpjNumeros.length === 14;
  }

  function adicionarFornecedor() {
    const nomeInput = document.getElementById('fornecedorNome');
    const cnpjInput = document.getElementById('fornecedorCNPJ');
    const emailInput = document.getElementById('fornecedorEmail');
    const contatoInput = document.getElementById('fornecedorContato');

    const nome = nomeInput.value.trim().toUpperCase();
    const cnpj = cnpjInput.value.trim().toUpperCase();
    const email = emailInput.value.trim().toLowerCase();
    const contato = contatoInput.value.trim().toUpperCase();

    if (!nome || !cnpj || !email) {
      alert('Preencha todos os campos obrigatórios.');
      return;
    }

    if (!validarCNPJ(cnpj)) {
      alert('CNPJ inválido. Deve conter 14 números.');
      return;
    }

    // Validação simples de email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      alert('Email inválido.');
      return;
    }

    // Verifica se já existe fornecedor com mesmo CNPJ ou email
    if (fornecedores.some(f => f.cnpj === cnpj)) {
      alert('Fornecedor com este CNPJ já cadastrado.');
      return;
    }
    if (fornecedores.some(f => f.email === email)) {
      alert('Fornecedor com este email já cadastrado.');
      return;
    }

    fornecedores.push({ nome, cnpj, email, contato, empenhos: [] });
    atualizarListaFornecedores();

    nomeInput.value = '';
    cnpjInput.value = '';
    emailInput.value = '';
    contatoInput.value = '';
  }

  function atualizarListaFornecedores() {
    const lista = document.getElementById('listaFornecedores');
    lista.innerHTML = '';

    fornecedores.forEach((f, i) => {
      const li = document.createElement('li');
      li.innerHTML = `
        <div>
          <strong>${f.nome}</strong> - CNPJ: ${f.cnpj} - Email: ${f.email} - Contato: ${f.contato || '-'}
        </div>
        <button onclick="abrirGestaoEmpenhos(${i})">Gerenciar Empenhos</button>
      `;
      lista.appendChild(li);
    });
  }

  // Variáveis para controle do modal e fornecedor atual
  let fornecedorAtualIndex = null;
  let itensEmpenho = [];

  function abrirGestaoEmpenhos(index) {
    fornecedorAtualIndex = index;
    const fornecedor = fornecedores[index];
    document.getElementById('modalFornecedorNome').textContent = fornecedor.nome;

    // Limpar formulário empenho e itens
    limparFormularioEmpenho();

    // Atualizar tabela de empenhos do fornecedor
    atualizarTabelaEmpenhos();

    // Mostrar modal
    document.getElementById('modalEmpenhos').style.display = 'block';
  }

  function fecharModalEmpenhos() {
    document.getElementById('modalEmpenhos').style.display = 'none';
    fornecedorAtualIndex = null;
    itensEmpenho = [];
  }

  // Limpa formulário e itens do empenho
  function limparFormularioEmpenho() {
    const campos = ['numeroEmpenho', 'planoInterno', 'notaCredito', 'pec', 'oog', 'recurso', 'descontoEmpenho', 'pregao', 'itemPregao', 'quantidadePregao', 'naturezaDespesa'];
    campos.forEach(id => {
      const el = document.getElementById(id);
      if (el.type === 'number') el.value = el.min || 0;
      else el.value = '';
    });

      // Limpar itens do empenho
    itensEmpenho = [];
    atualizarTabelaItensEmpenho();

    // Reset campos de item
    document.getElementById('descricaoItem').value = '';
    document.getElementById('valorUnitarioItem').value = '';
    document.getElementById('descontoItem').value = '0';

    atualizarTotaisEmpenho();
  }

  // Adicionar item ao empenho
  function adicionarItemEmpenho() {
    const descricao = document.getElementById('descricaoItem').value.trim().toUpperCase();
    const valorUnitario = parseFloat(document.getElementById('valorUnitarioItem').value);
    const desconto = parseFloat(document.getElementById('descontoItem').value) || 0;

    if (!descricao) {
      alert('Descrição do item é obrigatória.');
      return;
    }
    if (isNaN(valorUnitario) || valorUnitario <= 0) {
      alert('Valor unitário deve ser maior que zero.');
      return;
    }
    if (desconto < 0 || desconto > 100) {
      alert('Desconto deve estar entre 0 e 100%.');
      return;
    }

    // Adiciona item ao array
    itensEmpenho.push({
      descricao,
      valorUnitario,
      descontoItem: desconto,
      get valorTotal() {
        return this.valorUnitario * (1 - this.descontoItem / 100);
      }
    });

    // Limpar campos do item
    document.getElementById('descricaoItem').value = '';
    document.getElementById('valorUnitarioItem').value = '';
    document.getElementById('descontoItem').value = '0';

    atualizarTabelaItensEmpenho();
    atualizarTotaisEmpenho();
  }

  // Atualiza tabela de itens do empenho
  function atualizarTabelaItensEmpenho() {
    const tbody = document.querySelector('#tabelaItensEmpenho tbody');
    tbody.innerHTML = '';

    itensEmpenho.forEach((item, index) => {
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td>${item.descricao}</td>
        <td class="text-right">${item.valorUnitario.toFixed(2).replace('.', ',')}</td>
        <td class="text-right">${item.descontoItem.toFixed(2).replace('.', ',')}</td>
        <td class="text-right">${item.valorTotal.toFixed(2).replace('.', ',')}</td>
        <td class="text-center">
          <button class="btn-small" onclick="removerItemEmpenho(${index})" title="Remover Item">X</button>
        </td>
      `;

      tbody.appendChild(tr);
    });
  }

  // Remove item do empenho
  function removerItemEmpenho(index) {
    if (confirm('Deseja remover este item?')) {
      itensEmpenho.splice(index, 1);
      atualizarTabelaItensEmpenho();
      atualizarTotaisEmpenho();
    }
  }

  // Atualiza totais do empenho (itens, desconto geral, total com desconto)
  function atualizarTotaisEmpenho() {
    const valorTotalItens = itensEmpenho.reduce((acc, item) => acc + item.valorTotal, 0);
    const descontoGeral = parseFloat(document.getElementById('descontoEmpenho').value) || 0;
    const valorComDesconto = valorTotalItens * (1 - descontoGeral / 100);

    document.getElementById('valorTotalItens').textContent = valorTotalItens.toFixed(2).replace('.', ',');
    document.getElementById('descontoGeralExibido').textContent = descontoGeral.toFixed(2).replace('.', ',') + '%';
    document.getElementById('valorTotalComDesconto').textContent = valorComDesconto.toFixed(2).replace('.', ',');
  }

  // Atualiza totais ao mudar desconto geral
  document.getElementById('descontoEmpenho').addEventListener('input', atualizarTotaisEmpenho);

  // Adiciona empenho ao fornecedor
  function adicionarEmpenho() {
    if (fornecedorAtualIndex === null) {
      alert('Fornecedor não selecionado.');
      return;
    }

    const numeroEmpenho = document.getElementById('numeroEmpenho').value.trim().toUpperCase();
    if (!numeroEmpenho) {
      alert('Número do empenho é obrigatório.');
      return;
    }
    if (itensEmpenho.length === 0) {
      alert('Adicione pelo menos um item ao empenho.');
      return;
    }

    
    const planoInterno = document.getElementById('planoInterno').value.trim().toUpperCase();
    const notaCredito = document.getElementById('notaCredito').value.trim().toUpperCase();
    const pec = document.getElementById('pec').value.trim().toUpperCase();
    const oog = document.getElementById('oog').value.trim().toUpperCase();
    const recurso = document.getElementById('recurso').value.trim().toUpperCase();
    const descontoEmpenho = parseFloat(document.getElementById('descontoEmpenho').value) || 0;
    const pregao = document.getElementById('pregao').value.trim().toUpperCase();
    const itemPregao = parseInt(document.getElementById('itemPregao').value) || 0;
    const quantidadePregao = parseInt(document.getElementById('quantidadePregao').value) || 0;
    const naturezaDespesa = document.getElementById('naturezaDespesa').value.trim().toUpperCase();

    // Verifica se empenho já existe para o fornecedor
    const fornecedor = fornecedores[fornecedorAtualIndex];
    if (fornecedor.empenhos.some(e => e.numeroEmpenho === numeroEmpenho)) {
      alert('Empenho com este número já cadastrado para este fornecedor.');
      return;
    }

    // Monta objeto empenho
    const empenho = {
      numeroEmpenho,
      planoInterno,
      notaCredito,
      pec,
      oog,
      recurso,
      desconto: descontoEmpenho,
      pregao,
      itemPregao,
      quantidadePregao,
      naturezaDespesa,
      itens: [...itensEmpenho], // copia dos itens
      get valorTotalEmpenho() {
        const totalItens = this.itens.reduce((acc, item) => acc + item.valorTotal, 0);
        return totalItens * (1 - this.desconto / 100);
      }
    };

    // Adiciona empenho ao fornecedor
    fornecedor.empenhos.push(empenho);

    // Atualiza tabela e limpa formulário
    atualizarTabelaEmpenhos();
    limparFormularioEmpenho();

    alert('Empenho cadastrado com sucesso!');
  }

  // Atualiza tabela de empenhos do fornecedor atual
  function atualizarTabelaEmpenhos() {
    if (fornecedorAtualIndex === null) return;

    const fornecedor = fornecedores[fornecedorAtualIndex];
    const tbody = document.querySelector('#tabelaEmpenhos tbody');
    tbody.innerHTML = '';

    fornecedor.empenhos.forEach((e, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${e.numeroEmpenho}</td>
        <td>${e.planoInterno || '-'}</td>
        <td>${e.notaCredito || '-'}</td>
        <td>${e.pec || '-'}</td>
        <td>${e.oog || '-'}</td>
        <td>${e.recurso || '-'}</td>
        <td class="text-right">${e.desconto.toFixed(2).replace('.', ',')}%</td>
        <td>${e.pregao || '-'}</td>
        <td class="text-right">${e.itemPregao || '-'}</td>
        <td class="text-right">${e.quantidadePregao || '-'}</td>
        <td>${e.naturezaDespesa || '-'}</td>
        <td class="text-right">${e.valorTotalEmpenho.toFixed(2).replace('.', ',')}</td>
        <td class="text-center">
          <button class="btn-small" onclick="removerEmpenho(${i})" title="Remover Empenho">X</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Remove empenho do fornecedor atual
  function removerEmpenho(index) {
    if (fornecedorAtualIndex === null) return;
    if (confirm('Deseja remover este empenho?')) {
      fornecedores[fornecedorAtualIndex].empenhos.splice(index, 1);
      atualizarTabelaEmpenhos();
    }
  }

  // Fecha modal ao clicar fora do conteúdo
  window.onclick = function(event) {
    const modal = document.getElementById('modalEmpenhos');
    if (event.target === modal) {
      fecharModalEmpenhos();
    }
  };
</script>

</body>
</html>
